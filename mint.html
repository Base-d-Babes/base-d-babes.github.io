<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mint — Based_d Babes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ethers v6 (UMD, browser-safe) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <style>
    body {
      background: #0b0b0b;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      padding: 3rem 1rem;
    }
    h1 { font-weight: 600; }
    button {
      background: #fff;
      color: #000;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 1.5rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .error { color: #ff6b6b; }
    .success { color: #6bff95; }
    .tx-link { color: #7aa2ff; text-decoration: none; }
  </style>
</head>

<body>

  <h1>Based_d Babes — The Archetypes</h1>
  <p>Archetype #001: The Steward</p>

  <button id="connectBtn">Connect Wallet</button><br />
  <button id="mintBtn" disabled>Mint (0.003 ETH)</button>

  <div id="status" class="status"></div>

<script type="module">
/* ============================================================
   CANONICAL CONFIGURATION (DO NOT MUTATE POST-DEPLOY)
   ============================================================ */

const BASE_CHAIN_ID = 8453;

const COLLECTION_ADDRESS = "0x5dCFeD9D2897d9EA587a30EcDA5a069461Ca46Dd";
const ZORA_MINTER_ADDRESS = "0x04E2516A2c207E84a1839755675dfd8eF6302F0a";

const TOKEN_ID = 1;
const PRICE_PER_TOKEN = 0.003;
const MAX_SUPPLY = 50;
const MAX_PER_WALLET = 5;

/* ============================================================
   STATE
   ============================================================ */

let provider;
let signer;
let walletAddress;

/* ============================================================
   UI HELPERS
   ============================================================ */

const statusEl = document.getElementById("status");
const connectBtn = document.getElementById("connectBtn");
const mintBtn = document.getElementById("mintBtn");

function setStatus(message, type = "") {
  statusEl.className = `status ${type}`;
  statusEl.innerHTML = message;
}

/* ============================================================
   WALLET + NETWORK GUARDS
   ============================================================ */

async function ensureBaseNetwork() {
  const network = await provider.getNetwork();
  if (Number(network.chainId) !== BASE_CHAIN_ID) {
    throw new Error("Please switch to Base mainnet.");
  }
}

connectBtn.onclick = async () => {
  if (!window.ethereum) {
    setStatus("No wallet detected.", "error");
    return;
  }

  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    walletAddress = await signer.getAddress();

    await ensureBaseNetwork();

    connectBtn.textContent = "Wallet Connected";
    connectBtn.disabled = true;
    mintBtn.disabled = false;

    setStatus(`Connected: ${walletAddress.slice(0,6)}…${walletAddress.slice(-4)}`, "success");
  } catch (err) {
    setStatus(err.message, "error");
  }
};

/* ============================================================
   READ-ONLY SUPPLY CHECK (HARD GUARD)
   ============================================================ */

async function getTotalMinted() {
  const abi = ["function totalSupply(uint256) view returns (uint256)"];
  const contract = new ethers.Contract(COLLECTION_ADDRESS, abi, provider);
  const supply = await contract.totalSupply(TOKEN_ID);
  return Number(supply);
}

/* ============================================================
   MINT LOGIC (ZORA SALE STRATEGY)
   ============================================================ */

mintBtn.onclick = async () => {
  mintBtn.disabled = true;
  mintBtn.textContent = "Minting…";

  try {
    await ensureBaseNetwork();

    const minted = await getTotalMinted();
    if (minted >= MAX_SUPPLY) {
      throw new Error("Sold out.");
    }

    const zoraMinterAbi = [
      "function mint(address to, uint256 quantity, address collection, uint256 tokenId, address mintReferral) payable"
    ];

    const contract = new ethers.Contract(
      ZORA_MINTER_ADDRESS,
      zoraMinterAbi,
      signer
    );

    const tx = await contract.mint(
      walletAddress,
      1,
      COLLECTION_ADDRESS,
      TOKEN_ID,
      ethers.ZeroAddress,
      {
        value: ethers.parseEther(PRICE_PER_TOKEN.toString())
      }
    );

    setStatus(
      `Transaction sent.<br>
       <a class="tx-link" href="https://basescan.org/tx/${tx.hash}" target="_blank">
       View on BaseScan →
       </a>`,
      "success"
    );

    await tx.wait();

    setStatus("Mint confirmed on-chain.", "success");

  } catch (err) {
    console.error(err);
    setStatus(err.reason || err.message || "Mint failed.", "error");
  } finally {
    mintBtn.disabled = false;
    mintBtn.textContent = "Mint (0.003 ETH)";
  }
};
</script>

</body>
</html>
